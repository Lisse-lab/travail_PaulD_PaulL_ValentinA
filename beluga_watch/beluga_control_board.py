import dash
from dash import dcc, html, dash_table
from dash.dependencies import Input, Output
import plotly.graph_objs as go
import numpy as np
import librosa
import threading
import time
import folium
import os
from datetime import timedelta, datetime

# === Load audio files ===
audio_path1 = r"C:\Users\pauld\OneDrive\Bureau\Césure\Stage UQO\beluga-watch\test_data\full audios\8296.240729065600.wav"
audio_path2 = r"C:\Users\pauld\OneDrive\Bureau\Césure\Stage UQO\beluga-watch\test_data\full audios\8295.240729065600.wav"
audio_start_time = f"{audio_path1[-10:-8]}:{audio_path1[-8:-6]}:{audio_path1[-6:-4]}" 

y, sr1 = librosa.load(audio_path1, sr=None, mono=False)
y1 = y[1] if y.ndim > 1 and y.shape[0] > 1 else y
y, sr2 = librosa.load(audio_path2, sr=None, mono=False)
y2 = y[1] if y.ndim > 1 and y.shape[0] > 1 else y

#y1, sr1 = librosa.load(audio_path1, sr=None)
#y2, sr2 = librosa.load(audio_path2, sr=None)

min_len = min(len(y1), len(y2))
y1 = y1[:min_len]
y2 = y2[:min_len]

# Lecture en temps réel
class AudioStreamer:
    def __init__(self, data1, data2, sample_rate, chunk_duration=1.0, window_duration=3.0):
        self.data1 = data1
        self.data2 = data2
        self.sample_rate = sample_rate
        self.chunk_samples = int(chunk_duration * sample_rate)
        self.window_samples = int(window_duration * sample_rate)
        self.total_samples = len(data1)
        self.index = 0
        self.lock = threading.Lock()
        self.running = True
        self.thread = threading.Thread(target=self.update_index)
        self.thread.start()
        self.rms_times = []
        self.rms1_values = []
        self.rms2_values = []

    def update_index(self):
        while self.running and self.index + self.chunk_samples < self.total_samples:
            time.sleep(1.0)
            with self.lock:
                self.index += self.chunk_samples

    def get_current_chunk(self):
        with self.lock:
            start = max(0, self.index - self.window_samples)
            end = self.index
            return self.data1[start:end], self.data2[start:end], start / self.sample_rate

    def stop(self):
        self.running = False
        self.thread.join()

streamer = AudioStreamer(y1, y2, sr1)

# Entrées
groundtruths = [(47.940056, -69.530229), (47.939948, -69.530897)]
tetrahedrons_coords = [(47.93961, -69.52256), (47.94323, -69.51839)]

highlight_intervals = [(39, 41), (41, 42), (42, 45),
    (45, 47), (47, 48), (48, 48), (48, 49), (49, 50), (50, 51), (51, 52), (52, 53), (53, 54),
    (54, 55), (55, 56), (56, 57), (57, 58), (58, 59), (59, 60), (60, 61), (61, 64), (64, 64),
    (64, 66), (66, 67), (67, 68), (68, 69), (69, 70), (70, 71), (71, 72), (72, 74), (74, 78),
    (78, 78), (78, 79), (79, 81), (81, 81), (81, 82), (82, 83), (83, 84), (84, 85), (85, 86),
    (86, 88), (88, 89), (89, 90), (90, 91), (91, 92), (92, 93), (93, 94), (94, 96), (96, 97),
    (97, 98), (98, 99), (99, 101), (101, 106), (106, 110), (110, 111), (111, 112), (112, 113),
    (113, 114), (114, 119), (119, 120), (120, 125), (125, 126), (126, 127), (127, 129),
    (129, 131), (131, 132), (132, 133), (133, 134), (134, 160), (160, 161), (161, 162),
    (162, 163), (163, 164), (164, 165), (165, 166), (166, 167), (167, 169), (169, 176),
    (176, 177), (177, 178)
]

highlight_timestamps = [
    39.0, 41.2, 42.3, 45.3, 46.7, 47.6, 48.1, 49.0, 50.3,
    51.0, 52.0, 53.0, 54.5, 55.2, 56.0, 57.1, 58.0, 59.0, 60.0, 61.0, 63.6, 64.4, 66.0, 67.1,
    68.0, 69.1, 70.0, 71.0, 72.0, 74.0, 77.8, 78.5, 79.0, 80.8, 81.1, 82.0, 83.2, 84.1, 85.0,
    86.2, 87.5, 89.1, 90.1, 91.1, 92.4, 93.1, 94.0, 96.0, 97.0, 98.3, 99.0, 101.1, 106.4,
    110.0, 111.0, 112.0, 113.0, 114.0, 119.2, 120.3, 125.0, 126.2, 127.0, 128.9, 131.0,
    132.0, 133.3, 134.1, 160.2, 161.0, 162.0, 163.0, 164.0, 165.0, 166.0, 167.0, 169.3,
    176.0, 177.4, 178.0
]

highlight_durations = [0.1, 0.5, 0.2, 0.1, 0.1, 0.2, 0.9, 0.4, 0.4, 0.5, 0.4, 0.6, 0.4, 0.8, 0.9, 0.6, 0.9, 1.0, 0.9, 0.6, 0.3, 
                       0.4, 0.3, 0.9, 1.0, 0.9, 1.0, 0.9, 0.0, 0.7, 0.1, 0.1, 0.8, 0.2, 0.9, 0.4, 0.4, 0.1, 0.1, 0.5, 0.3, 0.9, 0.9, 0.9, 0.4, 0.9, 
0.8, 0.5, 0.3, 0.7, 0.3, 0.9, 0.4, 1.0, 1.0, 1.0, 1.0, 1.0, 0.4, 0.6, 0.2, 0.1, 0.7, 0.1, 0.4, 0.7, 0.1, 0.1, 0.7, 0.7, 1.0, 0.9, 0.7, 0.7, 1.0, 0.9, 0.2, 0.0, 0.3, 0.3]

highlight_coords = [
    (47.94048163, -69.52629898), (47.93859684, -69.53201674),
    (47.94037183, -69.52679024), (47.93934701, -69.52686857), (47.93990923, -69.52602545),
    (47.9405469, -69.52509959), (47.94034413, -69.52608775), (47.93997523, -69.52644856),
    (47.94086653, -69.5231756), (47.94003029, -69.52795986), (47.93995005, -69.52669976),
    (47.9399936, -69.52650245), (47.93932953, -69.52707852), (47.94003848, -69.52577864),
    (47.94016342, -69.52705522), (47.94019719, -69.52649056), (47.93995926, -69.52798014),
    (47.94002932, -69.52765042), (47.94003119, -69.52642388), (47.94006697, -69.52592754),
    (47.94186168, -69.52262562), (47.93968988, -69.52662649), (47.93997079, -69.52782433),
    (47.93997761, -69.52769973), (47.94022427, -69.53030782), (47.94027488, -69.53290741),
    (47.94028917, -69.53238081), (47.94022319, -69.5304623), (47.94041707, -69.52686911),
    (47.94014134, -69.525809), (47.93949801, -69.5280702), (47.9394399, -69.52685337),
    (47.9400801, -69.52564733), (47.94009485, -69.52716528), (47.93993704, -69.52713891),
    (47.93966757, -69.52906233), (47.94003848, -69.52751585), (47.93988753, -69.52763081),
    (47.93985004, -69.52793464), (47.93929554, -69.52867211), (47.93972787, -69.52713012),
    (47.94137186, -69.51137354), (47.93967946, -69.52687067), (47.93965916, -69.52634282),
    (47.93939307, -69.52721953), (47.93954927, -69.52678784), (47.93958714, -69.52798715),
    (47.93978537, -69.52811137), (47.94017927, -69.52710496), (47.94019576, -69.52695285),
    (47.93963156, -69.52644079), (47.94026371, -69.52652528), (47.93987124, -69.52539571),
    (47.94008256, -69.52602199), (47.94004739, -69.52642268), (47.93998253, -69.52655724),
    (47.94016135, -69.52535329), (47.94117157, -69.52482036), (47.93976857, -69.52661946),
    (47.93984372, -69.52546525), (47.94001215, -69.5272365), (47.94004235, -69.52617895),
    (47.94000815, -69.52654394), (47.93976385, -69.52559772), (47.93971248, -69.52734531),
    (47.93966361, -69.52725652), (47.94058729, -69.5237175), (47.93972779, -69.52542828),
    (47.93978452, -69.52622007), (47.93968627, -69.52342129), (47.93964052, -69.52682317),
    (47.9396219, -69.52698224), (47.93966517, -69.52678381), (47.93967406, -69.52662514),
    (47.93958699, -69.52703205), (47.93960115, -69.5269838), (47.93953453, -69.52357415),
    (47.94159526, -69.52488815), (47.94292668, -69.51737264), (47.94041835, -69.5231733)
]

distances_to_groundtruths = [322.07, 190.11, 284.03, 284.68, 338.16, 411.46, 335.53, 306.50, 558.62, 193.93,
 287.83, 302.47, 270.12, 356.41, 261.91, 304.13, 192.46, 216.98, 308.34, 345.37,
 626.37, 295.28, 204.03, 213.30, 31.18, 177.25, 139.12, 25.71, 279.00, 354.47,
 193.96, 283.31, 366.27, 253.31, 255.16, 117.81, 227.02, 218.79, 196.52, 161.28,
 257.53, 1437.50, 277.37, 316.67, 258.10, 285.68, 197.34, 184.21, 258.34, 269.78,
 309.82, 302.18, 385.19, 338.38, 308.46, 298.40, 388.48, 447.10, 294.90, 380.14,
 247.79, 326.60, 299.38, 370.81, 241.84, 249.16, 514.06, 383.70, 324.41, 533.15,
 281.47, 270.06, 283.99, 295.59, 267.04, 270.32, 523.19, 458.34, 1034.95, 552.40]

errors = [(0.23571702493640365, 0.9807927063466368), (0.30671085165534273, 1.1758303773950138), (0.3511994514622358, 1.130334879201937), (3.4462863708706974, 2.0356467246472527), 
          (1.9422318280168283, 0.9119522176140933), (0.20689838129798224, 0.8555850223151996), (0.521002591379124, 1.6562205999232944), (0.20482637627053302, 0.8897528231183133), 
          (0.11519315620929148, 0.4361139648184204), (0.2106721958036366, 0.8870553844903326), (0.0964463536379306, 0.4627377744425231), (0.2078610072433169, 0.821048317378803), 
          (0.34186616075750875, 0.7092272044923505), (0.6671991899290711, 0.24970332763693373), (0.933761754151273, 0.3472462180814186), (0.7601605984628245, 0.6745703110508579), 
          (1.4719263755923782, 1.4164777337049848), (1.4078678822783177, 1.440361574245863), (0.2110304877119621, 1.2126904983821074), (0.7722172040335454, 0.7859259505384223), 
          (1.0946520625288978, 1.026367347679368), (1.1370201392781123, 1.14208910283636), (0.9080586795570876, 1.3618383847483646), (0.14010356595451037, 0.5814539107235571), 
          (5.692613036809098, 2.388124577526561), (1.4627983876520871, 1.6293639084001446), (0.2472238042562875, 0.8459866256653562), (0.30427984607617986, 1.0394895547724332), 
          (1.5278518316261174, 1.9815360229286745), (0.475928507013, 1.612307344068672), (0.30522637206009134, 1.1676029882500434), (0.15849486385645636, 0.8820024736262841), 
          (0.6949941120315208, 1.0436204500176662), (0.16929198746986623, 1.0281139683248595), (2.4603238934762097, 1.5500183336136477), (9.27735688765611, 9.926687210453645), 
          (0.20987549453018375, 1.0046742488401186), (0.12082621725285607, 0.7941479736110983), (0.2333814837827077, 1.228168645060956), (0.13572583072951616, 1.1033202873823909), 
          (0.18029700963857145, 1.0064280284382414), (0.23169619793295212, 1.0763180875400646), (0.24598993571639097, 1.0584209112646161), (0.24183078596028884, 0.9928872923699451), 
          (0.17937550272427166, 0.9102649418489624), (0.15882715031612343, 0.9799458307140401), (0.23970600006661288, 1.04825258924618), (0.14358072828322732, 0.9498955814375559), 
          (0.31111016585579887, 1.0825822665421463), (0.31660240363916875, 1.0378040728080558), (1.2148284467915538, 1.99736573774176), (0.38412510677438966, 1.801094458317602), 
          (0.24636075360105372, 1.0260971606817968), (0.2499814165777628, 0.9790622916933297), (1.7186557105644304, 2.0408685800765367), (0.2575292690290661, 1.0265659103197728), 
          (0.10510959692344857, 0.6615437190748006), (0.2305787122274235, 1.0791303804729777), (0.07220179602570467, 0.5129184228088145), (0.22128405122896608, 1.0528862483239632), 
          (0.08055548302169484, 0.5407680761072778), (0.28448545813820925, 1.1009604406531335), (0.10764431661739861, 0.6577280504871778), (0.4114092786682189, 1.3212333585787328), 
          (1.2290786000489289, 0.9020814072153066), (0.25689774457641745, 1.157984719841233), (0.5515481863862179, 0.7232355270728934), (0.3676342134118788, 1.2182821148593794), 
          (0.3408735524392421, 1.438815959244256), (0.4142481768501262, 1.3001299622577973), (0.2748372193481307, 1.1177228146958749), (0.25930044680387315, 1.0226876802554552), 
          (0.19536564814048316, 0.8801071741545674), (1.1258291195599126, 1.1158389753222244), (0.21556775954986634, 1.1290720159904357), (1.877878340640805, 1.4857633762987823), 
          (0.24268064217372082, 1.1165615331053913), (0.2361290202336412, 1.122814744625295), (0.7391549672507279, 1.3106291621582662), (0.3192298944926363, 1.0397901376195018), 
          (0.24557761150357837, 1.2703516877230354), (0.190338136970821, 0.5290145445825953), (0.24372280328503992, 1.1395124019243497), (0.08202827111508938, 0.37654151703037325), 
          (0.2239275539732681, 1.0542549469879006), (0.2562165479600624, 1.2571961791685025), (0.28086090451115836, 1.326189482723142), (0.3667987068855944, 1.0294293213689572), 
          (0.23892158937839145, 1.201706778665173), (0.21179444057495733, 1.0406938790755933), (0.20434346218987953, 0.8430324494742092), (0.13006500892058506, 0.9139324651936606), 
          (0.24255004791318546, 1.0528590070279473), (0.25346573114026905, 1.0865298364875202), (0.18427599036025272, 1.006016835763185), (0.5805935020621193, 1.510631292841239), 
          (0.21024215179223252, 1.1313342187647903), (0.33136684492498747, 1.4682089036121981), (1.5199425369076487, 1.3541870741796556), (0.23071067624011687, 1.235183069009741), 
          (0.402074840637879, 1.2115970934109692), (0.9677675192675318, 0.9357006624879963), (0.31179363859235987, 1.3916014176708502), (0.6882939997487733, 1.4950252598603349), 
          (0.2861601089210799, 1.2491561787506442), (0.33184262373191736, 1.3299393829229376), (0.3304275190406978, 1.3846688038858967), (0.31781450672927386, 1.2670369433778514), 
          (1.6305561862336815, 1.344426074860895), (0.31827757321789724, 1.2803258695710058), (2.01660498969979, 0.2438826978460595), (0.28396680763834425, 1.4685887181562627), 
          (0.45420531822689475, 1.453127775421837), (1.621298514554986, 2.3927846671095816), (0.7945920090769119, 1.575790634920409), (3.0413264307327146, 1.7916469252450982), 
          (0.2880946973535661, 1.2458519986353773), (0.44467704224029975, 1.475713808871339), (0.2853672687894682, 1.2280261799675811), (0.43811390816673285, 1.4848222276988634), 
          (0.21423931451122114, 1.4240879575369771), (1.3222635388916866, 2.166538685222288), (2.1776272656659716, 0.4442043273090016), (0.18327342979832362, 1.036282819984313), 
          (0.11846601694749716, 1.0669288050618182), (0.24834804271366173, 1.2984605922822274), (1.919751361949042, 0.09736138399841111), (1.0717949934478328, 0.8400291281954883), 
          (0.5010168731590092, 2.238891092201263), (0.1548828960137994, 1.3044186386047412), (0.11709031077022658, 0.4602770612957909), (0.19819535452281709, 0.7901584819382899), 
          (1.2607869095243633, 0.304497655221196), (1.8613676872059488, 2.1327217216457983), (0.2881078389849167, 1.379676967103779), (18.27661600397227, 2.988420268446411), 
          (0.26842367452208626, 1.1989691275809433), (0.27948848676217136, 1.2448137046076597), (0.27933121783821946, 1.239683563345513), (0.29864206453276, 1.347106039904568), 
          (0.5721231497890898, 0.8417574240543731), (0.2284377187907916, 1.1601299732741779), (9.822394176844922, 3.6727859397948177), (0.9973705372829118, 0.781191522628345), 
          (6.259619288602546, 1.01534927324603), (7.3640544766681195, 0.5229062630358365), (0.9672035585267965, 0.5268144598927814), (7.38191470138, 1.0642667026235115), 
          (0.9253740846112739, 0.5023022759889102)]

# Structure
app = dash.Dash(__name__)

app.layout = html.Div([
    html.Div([
        dcc.Graph(id='spectrogram1', style={'width': '48%', 'height': '300px', 'display': 'inline-block'}),
        dcc.Graph(id='spectrogram2', style={'width': '48%', 'height': '300px', 'display': 'inline-block'})
    ], style={'display': 'flex', 'justifyContent': 'space-between'}),

    html.Div([
        html.Div([
            html.Iframe(id='map-frame', width='100%', height='100%', style={'border': 'none'})
        ], style={'width': '55%', 'marginLeft': '5%'}),

        html.Div([
            dash_table.DataTable(
                id='highlight-table',
                columns=[
                    {"name": "Temps", "id": "start"},
                    {"name": "Latitude", "id": "lat"},
                    {"name": "Longitude", "id": "lon"},
                    {"name": "Distance (m)", "id": "dis"},
                    {"name": "Erreur (m)", "id": "err"}
                ],
                data=[],
                style_table={'height': '100%', 'overflowY': 'auto'},
                style_cell={'textAlign': 'center'},
                style_header={'fontWeight': 'bold'}
            )
        ], style={'width': '35%', 'marginRight': '5%', 'overflowY': 'auto'})
    ], style={'display': 'flex', 'height': '250px', 'marginTop': '20px', 'justifyContent': 'space-between'}),

    dcc.Interval(id='interval', interval=1000, n_intervals=0)
])


# Mise à jour

@app.callback(
    [Output('spectrogram1', 'figure'),
     Output('spectrogram2', 'figure'),
     Output('map-frame', 'srcDoc'),
     Output('highlight-table', 'data')],
    [Input('interval', 'n_intervals')]
)

def update_visuals(n):
    data1, data2, start_time = streamer.get_current_chunk()

    n_fft = 1024
    hop_length = 256
    ref_power = 1e-12

    S1 = np.abs(librosa.stft(data1, n_fft=n_fft, hop_length=hop_length))**2
    S2 = np.abs(librosa.stft(data2, n_fft=n_fft, hop_length=hop_length))**2

    D1 = librosa.power_to_db(S1, ref=ref_power)
    D2 = librosa.power_to_db(S2, ref=ref_power)

    times = librosa.frames_to_time(np.arange(D1.shape[1]), sr=sr1, hop_length=hop_length)
    times += start_time
    freqs = librosa.fft_frequencies(sr=sr1, n_fft=n_fft)

    fig1 = go.Figure(data=go.Heatmap(z=D1, x=times, y=freqs, colorscale='Turbo', zmin=40, zmax=100))
    fig2 = go.Figure(data=go.Heatmap(z=D2, x=times, y=freqs, colorscale='Turbo', zmin=40, zmax=100))

    fig1.update_layout(title='T1 - 8296', xaxis_title='Temps [s]', yaxis_title='Fréquence [Hz]')
    fig2.update_layout(title='T2 - 8295', xaxis_title='Temps [s]', yaxis_title='Fréquence [Hz]')

    fig1.update_yaxes(type="log", range=[np.log10(500), np.log10(10000)])
    fig2.update_yaxes(type="log", range=[np.log10(500), np.log10(10000)])

    current_start = times[0]
    current_end = times[-1]
    ymin, ymax = freqs[0], freqs[-1]

    for i, start_timestamp in enumerate(highlight_timestamps):
        if start_timestamp+highlight_durations[i] >= current_start and start_timestamp <= current_end:
            x0 = max(start_timestamp, current_start)
            x1 = min(start_timestamp+highlight_durations[i], current_end)
            shape = dict(
                type="rect",
                xref="x",
                yref="y",
                x0=x0,
                x1=x1,
                y0=520,
                y1=9900,
                line=dict(color="red", width=1),
                fillcolor="rgba(255, 0, 0, 0.05)",
                layer="above"
            )
            fig1.add_shape(shape)
            fig2.add_shape(shape)

    active_index = None
    for i, (start_sec, end_sec) in enumerate(highlight_intervals):
        adjusted_start = start_sec + 1
        adjusted_end = end_sec + 1
        if current_start <= adjusted_start and current_end >= adjusted_end:
            active_index = i
        elif current_end < adjusted_start:
            active_index = i - 1 if i > 0 else None
            break
    else:
        if active_index is None and len(highlight_intervals) > 0:
            active_index = len(highlight_intervals) - 1

    m = folium.Map(location=groundtruths[0], zoom_start=14)

    for lat, lon in groundtruths:
        folium.Marker(location=[lat, lon],
                      icon=folium.DivIcon(html='<div style="font-size: 20pt; color: orange;">+</div>')).add_to(m)

    for lat, lon in tetrahedrons_coords:
        folium.Marker(location=[lat, lon],
                      icon=folium.DivIcon(html='<div style="font-size: 20pt; color: indigo;">▲</div>')).add_to(m)

    if active_index is not None and active_index < len(highlight_coords):
        lat, lon = highlight_coords[active_index]
        folium.Marker(location=[lat, lon],
                      icon=folium.DivIcon(html='<div style="font-size: 20pt; color: red;">+</div>')).add_to(m)

    map_html = m.get_root().render()

    if active_index is not None and active_index >= 0:

        table_data = [
            {"start": (datetime.strptime(audio_start_time, "%H:%M:%S") + timedelta(seconds=highlight_intervals[i][0])).strftime("%H:%M:%S"), "lat": highlight_coords[i][0], "lon": highlight_coords[i][1], "dis": distances_to_groundtruths[i], "err": round(np.sqrt(errors[i][0]**2+errors[i][1]**2), 3)}
            for i in range(active_index + 1)
        ]
    else:
        table_data = []

    fig1.update_layout(
        title={'text': 'T1 - 8296', 'x': 0.5, 'xanchor': 'center'},
        xaxis_title='Temps [s]',
        yaxis_title='Fréquence [Hz]'
    )

    fig2.update_layout(
        title={'text': 'T2 - 8295', 'x': 0.5, 'xanchor': 'center'},
        xaxis_title='Temps [s]',
        yaxis_title='Fréquence [Hz]'
    )

    return fig1, fig2, map_html, table_data


if __name__ == '__main__':
    app.run(debug=True)